{% extends "base.html" %}
{% load static %}

{% block title %}{{ product.name }} - FashionShop{% endblock %}

{% block css %}
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <style>
        .product-detail-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .product-detail {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-bottom: 40px;
        }
        
        .product-image {
            text-align: center;
        }
        
        .product-image img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .product-info {
            padding: 20px;
        }
        
        .product-title {
            font-size: 2.5rem;
            color: #333;
            margin-bottom: 10px;
        }
        
        .product-category {
            color: #666;
            font-size: 1.1rem;
            margin-bottom: 20px;
        }
        
        .product-price {
            font-size: 2rem;
            color: #e74c3c;
            font-weight: bold;
            margin-bottom: 30px;
        }
        
        .product-sizes {
            margin-bottom: 30px;
        }
        
        .product-sizes h4 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .size-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .size-option {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            background: white;
            transition: all 0.3s;
        }
        
        .size-option:hover {
            border-color: #3498db;
        }
        
        .size-option.selected {
            border-color: #3498db;
            background: #3498db;
            color: white;
        }
        
        .quantity-section {
            margin-bottom: 30px;
        }
        
        .quantity-section h4 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .quantity-btn {
            background: #3498db;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .quantity-btn:hover {
            background: #2980b9;
        }
        
        .quantity-input {
            width: 80px;
            text-align: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1.1rem;
        }
        
        .add-to-cart-section {
            margin-bottom: 30px;
        }
        
        .btn-add-to-cart {
            background: #27ae60;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 4px;
            font-size: 1.2rem;
            cursor: pointer;
            width: 100%;
            margin-bottom: 15px;
        }
        
        .btn-add-to-cart:hover {
            background: #229954;
        }
        
        .btn-add-to-cart:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        
        .btn-back {
            background: #6c757d;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-back:hover {
            background: #5a6268;
        }
        
        .alert {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        @media (max-width: 768px) {
            .product-detail {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .product-title {
                font-size: 2rem;
            }
            
            .product-price {
                font-size: 1.5rem;
            }
        }
    </style>
{% endblock %}

{% block content %}
<div class="product-detail-container">
    <a href="{% url 'home' %}" class="btn-back">← Quay lại danh sách sản phẩm</a>
    
    <div class="product-detail">
        <div class="product-image">
            <img src="{{ product.image.url }}" alt="{{ product.name }}" id="product-image">
        </div>
        
        <div class="product-info">
            <h1 class="product-title">{{ product.name }}</h1>
            <p class="product-category">Danh mục: {{ product.category.name }}</p>
            <div class="product-price">{{ product.formatted_price }}</div>
            
            <!-- Size Selection -->
            <div class="product-sizes">
                <h4>Chọn kích thước:</h4>
                <div class="size-options" id="size-options">
                    {% for product_size in product.productsize_set.all %}
                        <div class="size-option" data-size-id="{{ product_size.size.id }}" data-size-name="{{ product_size.size.name }}">
                            {{ product_size.size.name }}
                        </div>
                    {% empty %}
                        <div class="alert alert-warning">
                            Sản phẩm này hiện không có kích thước nào.
                        </div>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Quantity Selection -->
            <div class="quantity-section">
                <h4>Số lượng:</h4>
                <div class="quantity-controls">
                    <button class="quantity-btn" id="decrease-qty">-</button>
                    <input type="number" class="quantity-input" id="quantity" value="1" min="1" max="99">
                    <button class="quantity-btn" id="increase-qty">+</button>
                </div>
            </div>
            
            <!-- Add to Cart -->
            <div class="add-to-cart-section">
                <button class="btn-add-to-cart" id="add-to-cart-btn" {% if not product.productsize_set.all %}disabled{% endif %}>
                    {% if product.productsize_set.all %}
                        Thêm vào giỏ hàng
                    {% else %}
                        Sản phẩm không có sẵn
                    {% endif %}
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const sizeOptions = document.querySelectorAll('.size-option');
    const quantityInput = document.getElementById('quantity');
    const decreaseBtn = document.getElementById('decrease-qty');
    const increaseBtn = document.getElementById('increase-qty');
    const addToCartBtn = document.getElementById('add-to-cart-btn');
    
    let selectedSize = null;
    
    // Size selection
    sizeOptions.forEach(option => {
        option.addEventListener('click', function() {
            // Remove selected class from all options
            sizeOptions.forEach(opt => opt.classList.remove('selected'));
            
            // Add selected class to clicked option
            this.classList.add('selected');
            
            // Store selected size
            selectedSize = {
                id: parseInt(this.dataset.sizeId),
                name: this.dataset.sizeName
            };
            
            // Enable add to cart button if size is selected
            addToCartBtn.disabled = false;
        });
    });
    
    // Quantity controls
    decreaseBtn.addEventListener('click', function() {
        const currentQty = parseInt(quantityInput.value);
        if (currentQty > 1) {
            quantityInput.value = currentQty - 1;
        }
    });
    
    increaseBtn.addEventListener('click', function() {
        const currentQty = parseInt(quantityInput.value);
        if (currentQty < 99) {
            quantityInput.value = currentQty + 1;
        }
    });
    
    // Quantity input validation
    quantityInput.addEventListener('change', function() {
        let value = parseInt(this.value);
        if (isNaN(value) || value < 1) {
            this.value = 1;
        } else if (value > 99) {
            this.value = 99;
        }
    });
    
    // Add to cart functionality
    addToCartBtn.addEventListener('click', function() {
        if (!selectedSize) {
            alert('Vui lòng chọn kích thước!');
            return;
        }
        
        const quantity = parseInt(quantityInput.value);
        const productId = {{ product.id }};
        
        // Get existing cart or create new one
        let cart = JSON.parse(localStorage.getItem('fashion_cart') || '{"items": []}');
        
        // Check if item already exists in cart
        const existingItemIndex = cart.items.findIndex(item => 
            item.product_id === productId && item.size_id === selectedSize.id
        );
        
        if (existingItemIndex !== -1) {
            // Update quantity of existing item
            cart.items[existingItemIndex].quantity += quantity;
        } else {
            // Add new item to cart
            cart.items.push({
                product_id: productId,
                size_id: selectedSize.id,
                quantity: quantity
            });
        }
        
        // Save cart to localStorage
        localStorage.setItem('fashion_cart', JSON.stringify(cart));
        
        // Update cart count in navbar
        updateCartCount();
        
        // Show success message
        alert(`Đã thêm ${quantity} sản phẩm "${selectedSize.name}" vào giỏ hàng!`);
    });
    
    // Function to update cart count in navbar
    function updateCartCount() {
        const cart = JSON.parse(localStorage.getItem('fashion_cart') || '{"items": []}');
        const totalItems = cart.items.reduce((sum, item) => sum + item.quantity, 0);
        const cartCountElement = document.getElementById('cart-count');
        if (cartCountElement) {
            cartCountElement.textContent = totalItems;
        }
    }
    
    // Initialize cart count on page load
    updateCartCount();
});
</script>
{% endblock %}