{% extends 'base.html' %}
{% load static %}

{% block title %}Giỏ hàng{% endblock %}

{% csrf_token %}

{% block content %}
{% csrf_token %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <h2 class="text-center mb-4">Giỏ hàng của bạn</h2>
        </div>
    </div>
    
    <div class="row">
        <div class="col-12">
            <div id="cart-container">
                <!-- Cart items will be loaded here via JavaScript -->
                <div id="cart-loading" class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                    <p>Đang tải giỏ hàng...</p>
                </div>
                
                <div id="cart-empty" class="text-center" style="display: none;">
                    <img src="{% static 'img/img__cart.png' %}" alt="Empty cart" class="mb-3">
                    <h4>Giỏ hàng trống</h4>
                    <p>Bạn chưa có sản phẩm nào trong giỏ hàng</p>
                    <a href="{% url 'home' %}" class="btn btn-primary">Tiếp tục mua sắm</a>
                </div>
                
                <div id="cart-items" style="display: none;">
                    <!-- Cart items will be populated here -->
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4" id="cart-summary" style="display: none;">
        <div class="col-md-6 offset-md-6">
            <div class="card">
                <div class="card-body">
                    <h5>Tổng cộng</h5>
                    <div class="d-flex justify-content-between">
                        <span>Tạm tính:</span>
                        <span id="cart-subtotal">0đ</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Phí vận chuyển:</span>
                        <span>Miễn phí</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between">
                        <strong>Tổng cộng:</strong>
                        <strong id="cart-total">0đ</strong>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-success btn-block" id="checkout-btn" onclick="proceedToCheckout()">
                            Thanh toán
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden form for checkout -->
<form id="checkout-form" method="POST" action="{% url 'orders:checkout' %}" style="display: none;">
    {% csrf_token %}
    <input type="hidden" name="cart_data" id="checkout-cart-data">
</form>

<script>
// Cart management with LocalStorage
class CartManager {
    constructor() {
        this.cartKey = 'fashion_shop_cart';
        this.cart = this.loadCart();
        this.init();
    }
    
    init() {
        this.loadCartData();
        this.bindEvents();
    }
    
    loadCart() {
        const cartData = localStorage.getItem(this.cartKey);
        return cartData ? JSON.parse(cartData) : [];
    }
    
    saveCart() {
        localStorage.setItem(this.cartKey, JSON.stringify(this.cart));
    }
    
    addToCart(productId, sizeId, quantity = 1) {
        const existingItem = this.cart.find(item => 
            item.product_id === productId && item.size_id === sizeId
        );
        
        if (existingItem) {
            existingItem.quantity += quantity;
        } else {
            this.cart.push({
                product_id: productId,
                size_id: sizeId,
                quantity: quantity
            });
        }
        
        this.saveCart();
        this.loadCartData();
    }
    
    updateQuantity(productId, sizeId, quantity) {
        const item = this.cart.find(item => 
            item.product_id === productId && item.size_id === sizeId
        );
        
        if (item) {
            if (quantity <= 0) {
                this.removeFromCart(productId, sizeId);
            } else {
                item.quantity = quantity;
                this.saveCart();
                this.loadCartData();
            }
        }
    }
    
    removeFromCart(productId, sizeId) {
        this.cart = this.cart.filter(item => 
            !(item.product_id === productId && item.size_id === sizeId)
        );
        this.saveCart();
        this.loadCartData();
    }
    
    clearCart() {
        this.cart = [];
        this.saveCart();
        this.loadCartData();
    }
    
    async loadCartData() {
        if (this.cart.length === 0) {
            this.showEmptyCart();
            return;
        }
        
        try {
            const response = await fetch('{% url "cart:get_cart_data" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    cart_items: this.cart
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                this.displayCartItems(data.cart_data);
            } else {
                console.error('Error loading cart data:', data.message);
                this.showEmptyCart();
            }
        } catch (error) {
            console.error('Error loading cart data:', error);
            this.showEmptyCart();
        }
    }
    
    displayCartItems(cartData) {
        const cartItemsContainer = document.getElementById('cart-items');
        const cartSummary = document.getElementById('cart-summary');
        const cartLoading = document.getElementById('cart-loading');
        const cartEmpty = document.getElementById('cart-empty');
        
        cartLoading.style.display = 'none';
        cartEmpty.style.display = 'none';
        cartItemsContainer.style.display = 'block';
        cartSummary.style.display = 'block';
        
        let html = '';
        let total = 0;
        
        cartData.forEach(item => {
            const itemTotal = item.price * item.quantity;
            total += itemTotal;
            
            html += `
                <div class="card mb-3 cart-item" data-product-id="${item.product_id}" data-size-id="${item.size_id}">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-2">
                                <img src="${item.image}" alt="${item.name}" class="img-fluid" style="max-height: 100px;">
                            </div>
                            <div class="col-md-4">
                                <h5>${item.name}</h5>
                                <p class="text-muted">Size: ${item.size}</p>
                            </div>
                            <div class="col-md-2">
                                <span class="price">${item.price.toLocaleString('vi-VN')}đ</span>
                            </div>
                            <div class="col-md-2">
                                <div class="input-group">
                                    <button class="btn btn-outline-secondary btn-sm" onclick="cartManager.updateQuantity(${item.product_id}, ${item.size_id}, ${item.quantity - 1})">-</button>
                                    <input type="number" class="form-control text-center" value="${item.quantity}" min="1" 
                                           onchange="cartManager.updateQuantity(${item.product_id}, ${item.size_id}, parseInt(this.value))">
                                    <button class="btn btn-outline-secondary btn-sm" onclick="cartManager.updateQuantity(${item.product_id}, ${item.size_id}, ${item.quantity + 1})">+</button>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <span class="item-total">${itemTotal.toLocaleString('vi-VN')}đ</span>
                            </div>
                            <div class="col-md-1">
                                <button class="btn btn-danger btn-sm" onclick="cartManager.removeFromCart(${item.product_id}, ${item.size_id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        cartItemsContainer.innerHTML = html;
        document.getElementById('cart-subtotal').textContent = total.toLocaleString('vi-VN') + 'đ';
        document.getElementById('cart-total').textContent = total.toLocaleString('vi-VN') + 'đ';
    }
    
    showEmptyCart() {
        const cartItemsContainer = document.getElementById('cart-items');
        const cartSummary = document.getElementById('cart-summary');
        const cartLoading = document.getElementById('cart-loading');
        const cartEmpty = document.getElementById('cart-empty');
        
        cartLoading.style.display = 'none';
        cartItemsContainer.style.display = 'none';
        cartSummary.style.display = 'none';
        cartEmpty.style.display = 'block';
    }
    
    bindEvents() {
        // Bind checkout button
        document.getElementById('checkout-btn').addEventListener('click', () => {
            this.proceedToCheckout();
        });
    }
    
    proceedToCheckout() {
        // Redirect to checkout page
        window.location.href = '/orders/checkout/';
    }
}

// Initialize cart manager when page loads
let cartManager;
document.addEventListener('DOMContentLoaded', function() {
    cartManager = new CartManager();
});

// Global functions for template compatibility
function proceedToCheckout() {
    if (cartManager) {
        cartManager.proceedToCheckout();
    }
}
</script>
{% endblock %}
